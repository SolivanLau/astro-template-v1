---
import { Picture } from "astro:assets";
import { Icon } from "astro-icon/components";
import bgImage from "@images/newsletter-bg-desktop.webp";
import Input from "@components/forms/Input.astro";
---

<section class="background-image__parent">
    <div class="wrapper newsletter">
        <!-- Heading -->
        <div class="newsletter__text">
            <h2 class="title-font--display">Stay Informed</h2>
            <p class="h6">Get updates on concerts, events, and more!</p>
        </div>
        <!-- Form -->
        <form id="newsletter__form">
            <div class="title">
                <h3 class="h6 body-font">Join Our Mailing List</h3>
                <Icon name="mail" />
            </div>
            <!-- Inputs -->
            <div class="inputs">
                <Input inputType="email" name="Email" id="email" />
                <Input inputType="text" name="First Name" id="first-name" />
                <Input inputType="text" name="Last Name" id="last-name" />
                <div
                    class="cf-turnstile"
                    data-sitekey={process.env.TURNSTILE_SITE_KEY}
                    data-size="flexible"
                    data-theme="light"
                >
                </div>
            </div>

            <div class="response">
                <button class="button-primary" type="submit">Sign Up</button>
                <div class="status">
                    <div class="status__icon">
                        <Icon name="success" />
                        <Icon name="error" />
                    </div>
                    <p class="status__message">test</p>
                </div>
            </div>
        </form>
    </div>
    <!-- Background Image -->
    <Picture
        class="background-image"
        src={bgImage}
        alt="Toronto Wind Collective Rehearsal Shot"
        width={1920}
        formats={["webp", "jpg"]}
    />
</section>

<style lang="scss">
    @use "@styles/partials/abstracts/mixins" as *;

    // Background Image
    .background-image__parent {
        background: linear-gradient(-85.41deg, rgba(66, 58, 112, 17%) 0%, #695c7c 58%);
    }
    .background-image {
        translate: 38%;
    }
    // Layout
    .newsletter {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spc-lg) var(--spc-med);
        padding: var(--spc-xl) 0;
    }
    // Text
    .newsletter__text {
        color: var(--clr-white);
        display: grid;
        gap: var(--spc-sm);
        text-wrap: balance;
    }
    // Form
    #newsletter__form {
        --form--padding: 48px;
        background-color: #ffffff;
        color: #1a1a1a;
        padding: var(--form--padding);
        min-width: 350px;
        width: 40%;
        display: grid;
        gap: 32px;
        -webkit-box-shadow: 5px 4px 3.3px 0px rgba(0, 0, 0, 0.25);
        -moz-box-shadow: 5px 4px 3.3px 0px rgba(0, 0, 0, 0.25);
        box-shadow: 5px 4px 3.3px 0px rgba(0, 0, 0, 0.25);

        & > * {
            width: 100%;
        }
        .title {
            display: flex;
            align-items: center;
            gap: 12px;
            // TEMPORARY MARGIN REMOVAL: MOVE TO GLOBALS
            h3 {
                margin: 0;
            }
            [data-icon="mail"] {
                font-size: 30px;
            }
        }
    }

    // inputs
    .inputs {
        display: grid;
        gap: 12px;
    }

    // submit button
    .response {
        display: grid;
        gap: 12px;
        button[type="submit"] {
            width: 100%;
        }
    }
    // status text
    .status {
        min-height: 72px;
        padding: 16px 12px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        opacity: 0;
        transition: 0.3s ease-in-out opacity;
        // SUCCESS STYLES
        color: #255634;
        border: 2px hsla(138, 35%, 38%, 0.399) solid;
        background-color: #c9f6d7;

        [data-icon] {
            font-size: 26px;
        }

        [data-icon="error"] {
            display: none;
        }

        // ERROR RESPONSE
        &.error {
            color: #78140b;
            border: 2px hsla(5, 35%, 38%, 0.37) solid;
            background-color: #f6d0c9;

            [data-icon="success"] {
                display: none;
            }
            [data-icon="error"] {
                display: block;
            }
        }

        // RESPONSE ANIMATION
        &.respond {
            opacity: 1;
        }

        .status__message {
            white-space: pre-line;
        }
    }

    // MEDIA QUERIES

    // TABLET
    @include responsive-style(1030px) {
        #newsletter__form {
            --form--padding: var(--spc-lg);
        }
    }

    @include responsive-style(950px) {
        // Layout Shift
        .newsletter {
            flex-direction: column;
        }
        .newsletter__text {
            text-align: center;
        }

        #newsletter__form {
            min-width: none;
            width: 100%;
            max-width: 550px;
        }
    }

    @include responsive-style(tablet) {
        #newsletter__form {
            --form--padding: var(--spc-med);
        }
    }
    // MOBILE
</style>

<script>
    declare const turnstile: any;

    const newsletterForms = document.querySelectorAll("#newsletter__form");

    // Newsletter Submission
    newsletterForms.forEach((form) => {
        // DOM Elements
        const newsletterForm = form as HTMLFormElement;
        const submitButton = newsletterForm.querySelector(
            'button[type="submit"]',
        ) as HTMLButtonElement;
        const turnstileWidget = newsletterForm.querySelector(".cf-turnstile");
        const status = newsletterForm.querySelector(".status");
        const statusMessage = newsletterForm.querySelector(".status__message");

        statusMessage.classList.remove("respond");

        newsletterForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const url: string = "/api/newsletter";
            submitButton.disabled = true;

            // Reset status and message each submission
            status.classList.remove("respond", "error");
            statusMessage.textContent = "";

            const formData = new FormData(newsletterForm);

            // API REQUEST
            try {
                const request = await fetch(url, {
                    method: "POST",
                    body: formData,
                });
                // // network and CORS errors
                if (!request.ok) {
                    console.log("request", request);

                    throw new Error(request.statusText);
                }

                const response = await request.json();

                // API RESPONSE
                if (!response.success) {
                    console.error("Error subscribing to newsletter:", response);
                    statusMessage.textContent = ` ${response.message}`;
                    status.classList.add("error");
                    return;
                }

                statusMessage.textContent = `Welcome to the collective!\nWe'll keep you updated with new events.`;
                status.classList.remove("error");
                // Reset form on success
                newsletterForm.reset();
            } catch (error) {
                console.log("ERROR", error);

                console.error(`Error subscribing to newsletter: ${error}`);
                statusMessage.textContent = `${error}`;
                status.classList.add("error");
            } finally {
                turnstile.reset(turnstileWidget);
                status.classList.add("respond");
                submitButton.disabled = false;
            }
        });
    });
</script>
